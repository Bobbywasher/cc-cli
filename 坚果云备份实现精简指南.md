# 坚果云备份实现精简指南

## 核心架构

### 技术栈
- **认证**: OAuth 2.0 + SSO
- **传输**: WebDAV协议 (https://dav.jianguoyun.com/dav)
- **状态**: Redux Toolkit
- **加密**: AES-256-GCM
- **压缩**: archiver (ZIP)

### 模块分层
```
渲染进程: UI组件 → 服务层 → 状态管理
    ↓ IPC通信
主进程: OAuth模块 → WebDAV客户端 → 备份管理
    ↓ HTTPS
坚果云WebDAV服务
```

## OAuth认证流程

### 1. SSO URL生成 (主进程)
```typescript
// src/main/services/NutstoreService.ts
import { createOAuthUrl } from '../integration/nutstore/sso/lib/index.mjs'

export async function getNutstoreSSOUrl(): Promise<string> {
  return await createOAuthUrl({
    app: 'cherrystudio',
    redirect_uri: 'https://localhost:3000/callback',
    scope: 'read,write'
  })
}
```

### 2. 令牌处理
```typescript
// 令牌加密存储
const encryptedToken = await encryptSecret({
  app: 'cherrystudio',
  data: JSON.stringify(tokenResponse)
})

// 令牌解密验证
const tokenData = await decryptSecret({
  app: 'cherrystudio',
  s: encryptedToken
})
```

## WebDAV客户端实现

### 核心配置
```typescript
// src/main/services/WebDav.ts
import { createClient } from 'webdav'

export default class WebDav {
  constructor(config: WebDavConfig) {
    this.instance = createClient(config.webdavHost, {
      username: config.webdavUser,      // 坚果云用户名
      password: config.webdavPass,      // OAuth access_token
      timeout: 30000,
      headers: {
        'User-Agent': 'CherryStudio/1.0.0 WebDAV Client'
      }
    })
  }

  // 上传文件
  async putFileContents(filename: string, data: Buffer): Promise<boolean> {
    await this.ensureDirectoryExists(this.webdavPath)
    await this.instance.putFileContents(
      path.posix.join(this.webdavPath, filename),
      data
    )
    return true
  }

  // 下载文件
  async getFileContents(filename: string): Promise<Buffer> {
    return await this.instance.getFileContents(
      path.posix.join(this.webdavPath, filename),
      { format: 'binary' }
    ) as Buffer
  }
}
```

## Redux状态管理

### 状态定义
```typescript
// src/renderer/src/store/nutstore.ts
export interface NutstoreState {
  nutstoreToken: string | null          // 加密OAuth令牌
  nutstoreUser: string | null           // 用户信息
  nutstorePath: string                  // 备份路径
  nutstoreAutoSync: boolean             // 自动同步开关
  nutstoreSyncInterval: number          // 同步间隔(分钟)
  nutstoreMaxBackups: number            // 最大备份数量
  nutstoreSyncState: {
    lastSyncTime: number | null
    syncing: boolean
    syncProgress: number
    lastSyncError: string | null
  }
}
```

### Actions
```typescript
const nutstoreSlice = createSlice({
  name: 'nutstore',
  initialState,
  reducers: {
    setNutstoreToken: (state, action) => {
      state.nutstoreToken = action.payload
    },
    setNutstoreSyncState: (state, action) => {
      state.nutstoreSyncState = { ...state.nutstoreSyncState, ...action.payload }
    }
  }
})
```

## 自动同步机制

### AutoSyncManager核心逻辑
```typescript
// src/renderer/src/services/AutoSyncManager.ts
export class NutstoreAutoSyncManager {
  private syncTimer: NodeJS.Timeout | null = null

  async start(): Promise<void> {
    const state = store.getState().nutstore
    if (!state.nutstoreToken || !state.nutstoreAutoSync) return

    this.scheduleNextSync()
  }

  private scheduleNextSync(): void {
    const intervalMs = store.getState().nutstore.nutstoreSyncInterval * 60 * 1000
    this.syncTimer = setTimeout(() => {
      this.performSync()
    }, intervalMs)
  }

  private async performSync(): Promise<void> {
    try {
      await nutstoreService.backupToNutstore({ showMessage: false })
      store.dispatch(setNutstoreSyncState({
        lastSyncTime: Date.now(),
        lastSyncError: null
      }))
    } catch (error) {
      store.dispatch(setNutstoreSyncState({
        lastSyncError: error.message
      }))
    }
    this.scheduleNextSync()
  }
}
```

## 备份核心服务

### 备份流程
```typescript
// src/renderer/src/services/NutstoreService.ts
export async function backupToNutstore(options = {}) {
  // 1. 获取令牌和创建WebDAV配置
  const nutstoreToken = store.getState().nutstore.nutstoreToken
  const config = await createNutstoreConfig(nutstoreToken)

  // 2. 获取备份数据
  const backupData = await getBackupData()

  // 3. 生成文件名
  const timestamp = dayjs().format('YYYYMMDDHHmmss')
  const fileName = `cherry-studio.${timestamp}.zip`

  // 4. 清理旧备份
  await cleanupOldBackups(config, maxBackups)

  // 5. 执行备份
  const success = await window.api.backup.backupToWebdav(backupData, {
    ...config,
    fileName
  })

  return success
}

// 创建WebDAV配置
async function createNutstoreConfig(encryptedToken: string) {
  const tokenData = await window.api.nutstore.decryptToken(encryptedToken)
  return {
    webdavHost: 'https://dav.jianguoyun.com/dav',
    webdavUser: tokenData.username,
    webdavPass: tokenData.access_token,  // OAuth令牌作为密码
    webdavPath: store.getState().nutstore.nutstorePath
  }
}
```

## 错误处理

### 错误分类
```typescript
export enum NutstoreErrorType {
  NETWORK_ERROR = 'NETWORK_ERROR',      // 网络错误 - 可重试
  AUTH_ERROR = 'AUTH_ERROR',            // 认证错误 - 需重新认证
  QUOTA_ERROR = 'QUOTA_ERROR',          // 配额不足 - 清理备份
  SERVER_ERROR = 'SERVER_ERROR'         // 服务器错误 - 延迟重试
}

// 重试管理器
export class RetryManager {
  static async withRetry(operation, options = {}) {
    const { maxRetries = 3, retryDelays = [1000, 2000, 4000] } = options

    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        return await operation()
      } catch (error) {
        if (attempt === maxRetries || !shouldRetry(error)) {
          throw error
        }
        await new Promise(resolve =>
          setTimeout(resolve, retryDelays[attempt])
        )
      }
    }
  }
}
```

## UI组件集成

### 配置界面关键组件
```typescript
// src/renderer/src/components/settings/NutstoreSettings.tsx
export const NutstoreSettings: React.FC = () => {
  const dispatch = useDispatch()
  const nutstoreState = useSelector(state => state.nutstore)

  // OAuth认证
  const handleAuthenticate = async () => {
    const ssoUrl = await window.api.nutstore.getSSOUrl()
    // 打开认证窗口处理回调
  }

  // 手动备份
  const handleManualBackup = async () => {
    await nutstoreService.backupToNutstore({ showMessage: true })
  }

  // 自动同步切换
  const handleAutoSyncChange = async (enabled: boolean) => {
    dispatch(setNutstoreAutoSync(enabled))
    if (enabled) {
      await nutstoreService.startAutoSync()
    } else {
      await nutstoreService.stopAutoSync()
    }
  }

  return (
    <div>
      {/* 认证状态、路径配置、自动同步设置、备份文件列表 */}
    </div>
  )
}
```

## 部署配置

### 环境要求
```json
{
  "node": ">=16.0.0",
  "dependencies": {
    "webdav": "^4.11.2",
    "archiver": "^5.3.1",
    "@reduxjs/toolkit": "^1.9.5"
  }
}
```

### 关键配置项
```typescript
export const NUTSTORE_CONFIG = {
  HOST: 'https://dav.jianguoyun.com/dav',
  APP_ID: 'cherrystudio',
  DEFAULT_BACKUP_PATH: '/cherry-studio',
  WEBDAV_TIMEOUT: 30000,
  MAX_BACKUP_SIZE: 100 * 1024 * 1024,  // 100MB
  ENCRYPTION_ALGORITHM: 'AES-256-GCM'
}
```

## 实现要点总结

1. **OAuth认证**: 使用混淆加密库生成SSO URL，处理回调获取access_token
2. **WebDAV操作**: access_token作为Basic认证密码，实现文件CRUD操作
3. **状态管理**: Redux管理配置和同步状态，持久化非敏感数据
4. **自动同步**: 定时器+重试机制，支持网络状态检测和错误恢复
5. **安全策略**: 令牌AES加密存储，HTTPS传输，访问控制验证
6. **用户界面**: React组件集成认证、配置、状态显示功能

通过以上架构可完整实现坚果云OAuth+WebDAV备份功能。